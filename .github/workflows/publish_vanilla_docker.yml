name: Release version

on:
  workflow_dispatch:

env:
  IMAGE_NAME: ${{ github.repository }}

jobs:
  calculate_version:
    uses: ./.github/workflows/semantic_versioning.yml

  release:
    needs:
      - calculate_version
    permissions:
      contents: write
      packages: write
    uses: ./.github/workflows/build_docker.yml
    with:
      ghcr_username: ${{ github.actor }}
      ghcr_password: ${{ secrets.ACTIONS_BOT_TOKEN }}
      dockerhub_username: ${{ secrets.DOCKERHUB_LOGIN }}
      dockerhub_password: ${{ secrets.DOCKERHUB_TOKEN }}
      image_name: ghcr.io/${{ env.IMAGE_NAME }}
      image_tag: ${{ needs.calculate_version.outputs.next_version }}
      push: true
      scan: true
      image_extra_aliases: |
        ${{ github.ref == 'refs/heads/development' && format('{0}/{1}:{2}', 'ghcr.io', env.IMAGE_NAME, 'development') || ''}}
        ${{ startsWith(github.ref, 'refs/heads/release-') && needs.calculate_version.outputs.is_latest == 'true' && format('{0}/{1}:{2}', 'ghcr.io', env.IMAGE_NAME, 'latest') || ''}}