name: Test

on:
  workflow_call:
    inputs:
      bypass_checks:
        type: boolean
        default: false
        description: Do not fail pipeline if checks failed
      enable_style_checks:
        type: boolean
        default: true
        description: Enable style_checks
      bypass_style_checks:
        type: boolean
        default: false
        description: Do not fail pipeline if style_checks failed
      enable_ort:
        type: boolean
        default: true
        description: Enable ORT scanning
      bypass_ort:
        type: boolean
        default: false
        description: Do not fail pipeline if ORT scan failed
      enable_trivy:
        type: boolean
        default: true
        description: Enable Trivy scanning
      bypass_trivy:
        type: boolean
        default: false
        description: Do not fail pipeline if Trivy failed
      gcp_project_id:
        type: string
        default: "hl2-epm-dial-test-t1iylu"  
        description: "Google project ID"
      gcp_workload_identity_provider:
        type: string
        default: "projects/771246914069/locations/global/workloadIdentityPools/ab-test-github-actions/providers/test-github-actions-oidc"
        description: "Google workload identity provider"
      gcp_service_account:
        type: string
        description: "Google service_account"
        default: "ab-test-github-actions@hl2-epm-dial-test-t1iylu.iam.gserviceaccount.com"
      gcp_location:
        type: string
        description: "Google artifact location"
        default: "us-central1"
      gcp_repo:
        type: string
        description: "Google artifact repository name"
        default: "test-docker"

env:
  IMAGE_NAME: debug
  IMAGE_TAG: ${{ github.sha }}

jobs:
  some_test:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'
    steps:
      - name: some test
        shell: bash
        run: |
          echo "Test"
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@8254fb75a33b976a221574d287e93919e6a36f70 # v2.1.6

        with:
          project_id: ${{ inputs.gcp_project_id }}
          workload_identity_provider: ${{ inputs.gcp_workload_identity_provider }}
          service_account: ${{ inputs.gcp_service_account }}
  # test:
  #   uses: ./.github/workflows/generic_docker_test.yml
  #   with:
  #     bypass_checks: ${{ inputs.bypass_checks }}
  #     enable_style_checks: ${{ inputs.enable_style_checks }}
  #     bypass_style_checks: ${{ inputs.bypass_style_checks }}
  #     enable_ort: ${{ inputs.enable_ort }}
  #     bypass_ort: ${{ inputs.bypass_ort }}

  docker_build:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'
    steps:
      - uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          lfs: true
      - uses: alexey-ban/ai-dial-ci/actions/build_docker@main
        with:
          image_name: ${{ inputs.gcp_location }}-docker.pkg.dev/${{ inputs.gcp_project_id }}/${{ inputs.gcp_repo }}/${{ env.IMAGE_NAME }}
          image_tag: ${{ env.IMAGE_TAG }}
          push_private: true
          scan: ${{ inputs.enable_trivy }}
          bypass_checks: ${{ inputs.bypass_trivy }}
          gcp_project_id: ${{ inputs.gcp_project_id }}
          gcp_workload_identity_provider: ${{ inputs.gcp_workload_identity_provider }}
          gcp_service_account: ${{ inputs.gcp_service_account }}